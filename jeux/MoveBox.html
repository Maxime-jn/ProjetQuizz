<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8" />
  <title>Move the Box - Empilement & Gravit√©</title>
  <style>
    body {
      background: #222;
      text-align: center;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }

    canvas {
      background: #111;
      display: block;
      margin: 0 auto;
      border: 3px solid #555;
      box-shadow: 0 8px 32px #0008, 0 2px 8px #000a;
      border-radius: 18px;
      transition: box-shadow 0.4s;
      /* facultatif : si tu forces une taille CSS diff√©rente, les clics restent justes gr√¢ce au scale */
      max-width: 80%;
      height: 490px;
    }

    #info {
      font-size: 18px;
    }

    #message {

      font-size: 12px;
      height: 15px;
      font-weight: bold;
      letter-spacing: 1px;
      min-height: 15px;
      text-shadow: 0 2px 8px #0007;
      color: #fff;
    }

    .boutonDiv {
      display: flex;

    }

    button {
      margin-top: 3px;
      margin-right: 5px;
      margin-left: 5px;
      padding: 10px 22px;
      width: 190px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 8px;
      border: none;
      background: linear-gradient(90deg, #333 60%, #555 100%);
      color: white;
      box-shadow: 0 2px 8px #0006;
      transition: background 0.3s, box-shadow 0.3s, transform 0.13s;
      font-weight: bold;
    }

    button:hover {
      background: linear-gradient(90deg, #444 50%, #777 100%);
      transform: scale(1.05);
      box-shadow: 0 4px 16px #0007;
    }

    h2,
    p {
      color: white;
      margin-top: 10px;
      letter-spacing: 1px;
      text-shadow: 0 3px 14px #0008;
      font-size: 1.4em;
    }
  </style>

</head>

<body>
  <h2>Move the Box ‚Äì Empilement & Gravit√©</h2>
  <canvas id="game" width="400" height="500"></canvas>
  <p id="info">Mouvements restants : <span id="moves">20</span></p>
  <div id="message"></div>
  <div class="boutonDiv">
    <button id="resetBtn">Recommencer</button>
    <button id="rulesBtn">R√®gles</button>
  </div>


  <script>
    // ====== NIVEAUX PR√âD√âFINIS ======

    const COLORS = [
      '#2ecc40',  // vert
      '#f3e6c6',  // beige
      '#8d5524',  // marron
      '#b5b5b5',  // gris
      '#e74c3c',  // rouge
      '#3d2424'   // marron fonc√©
    ];

    const COLOR_NAMES = {
      vert: '#22c55e', // plus vif
      beige: '#f5d7a1', // plus chaud
      marron: '#8b5a2b',
      marronF: '#4a2b16',
      gris: '#c1c1c1',
      rouge: '#ef4444'  // plus vif
    };



    const LEVELS = [
      // Niveau 1 (index 0)
      {
        name: "Niveau 1",
        moves: 3,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, "marron", null, null, null],
          [null, null, null, "marron", "marronF", "marron", null, null],
          [null, null, "marronF", "marronF", "marron", "marronF", "marronF", null],
        ]
      },
      // Niveau 2 (index 0)
      {
        name: "Niveau 2",
        moves: 3,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, "beige", "marron", "beige", null, "beige", "marron", "beige"],
          [null, "marron", "beige", "marron", "beige", "marron", "beige", "marron"],
        ]
      },
      // Niveau 3 (index 0)
      {
        name: "Niveau 3",
        moves: 4,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, "vert", null, null, null],
          [null, null, null, null, "beige", null, null, null],
          [null, null, null, "beige", "marron", null, null, null],
          [null, null, null, "vert", "vert", "marron", null, null],
          [null, null, null, "marron", "marron", "gris", "marron", null],
          [null, null, null, "marron", "beige", "beige", "gris", "gris"]
        ]
      },
      // Niveau 4 (index 1)
      {
        name: "Niveau 4",
        moves: 3,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, "vert", null, null, null, null],
          [null, null, null, "beige", null, null, null, null],
          [null, null, null, "rouge", null, null, null, null],
          [null, null, null, "beige", null, "gris", null, null],
          [null, null, null, "marron", null, "vert", "gris", null],
          [null, null, null, "beige", "rouge", "marron", "vert", "vert"],
          [null, null, null, "vert", "vert", "rouge", "marron", "gris"]
        ]
      },
      // Niveau 5 (index 1)
      {
        name: "Niveau 5",
        moves: 2,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, "beige", null],
          [null, null, null, null, null, null, "rouge", null],
          [null, null, null, null, null, null, "beige", "beige"],
          [null, null, null, null, null, null, "beige", "rouge"],
          [null, null, null, null, null, null, "rouge", "beige"],
          [null, null, null, null, "beige", null, "rouge", "beige"],
        ]
      },
      // Niveau 6 (index 1)
      {
        name: "Niveau 6",
        moves: 3,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, "marron", "marron", null, null],
          [null, null, "marron", "vert", "beige", "vert", "beige", "beige"],
          [null, null, "marron", "marron", "vert", "marron", "beige", "marron"],
        ]
      },
      // Niveau 7 (index 1)
      {
        name: "Niveau 7",
        moves: 2,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, "vert", null, null, null],
          [null, null, null, null, "rouge", null, null, null],
          [null, null, null, null, "rouge", "vert", "vert", null],
          [null, null, null, null, "marron", "marron", "rouge", "marron"],
        ]
      },
      // Niveau 8 (index 1)
      {
        name: "Niveau 8",
        moves: 3,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, "gris", null, null, null, null, null],
          [null, null, "beige", null, null, null, null, null],
          [null, null, "gris", "vert", "rouge", null, null, null],
          [null, null, "gris", "beige", "beige", null, null, null],
          [null, null, "beige", "rouge", "vert", null, null, null],
          [null, null, "vert", "beige", "rouge", null, null, null],
        ]
      },
      // Niveau 9 (index 1)
      {
        name: "Niveau 9",
        moves: 2,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, "gris", null, null, null, null],
          [null, null, "gris", "rouge", null, null, null, null],
          [null, null, "rouge", "gris", "rouge", null, null, null],
          [null, null, "gris", "rouge", "gris", null, null, null],
          [null, null, "rouge", "gris", "rouge", null, null, null],
          [null, null, "gris", "rouge", "gris", null, null, null],
          [null, null, "rouge", "gris", "rouge", null, null, null],
          [null, null, "gris", "rouge", "gris", null, null, null],
          [null, null, "rouge", "gris", "rouge", null, null, null],
        ]
      },
      // Niveau 10 (index 1)
      {
        name: "Niveau 10",
        moves: 4,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, "beige", null, null],
          [null, null, "beige", null, null, "rouge", null, null],
          [null, null, "rouge", null, null, "beige", null, null],
          [null, null, "beige", null, null, "rouge", null, null],
          [null, null, "rouge", null, null, "beige", null, null],
          [null, null, "beige", null, null, "rouge", null, null],
        ]
      },
      // Niveau 11 (index 1)
      {
        name: "Niveau 11",
        moves: 3,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, "marronF", "marronF", null, null],
          [null, null, null, "beige", "vert", "beige", null, null],
          [null, null, null, "vert", "vert", "marronF", null, null],
          [null, null, null, "marronF", "marronF", "beige", null, null],
          [null, null, null, "vert", "vert", "marronF", "vert", null],
        ]
      },
      // Niveau 12 (index 1)
      {
        name: "Niveau 12",
        moves: 3,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, "beige", null, null, null, null],
          [null, null, null, "vert", "vert", "beige", null, null],
          [null, "marronF", "marronF", "vert", "beige", "marronF", null, null],
        ]
      },
      // Niveau 13 (index 1)
      {
        name: "Niveau 13",
        moves: 2,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, "gris", null, null, null, null],
          [null, null, "vert", "rouge", null, null, null, null],
          [null, null, "vert", "rouge", null, "gris", null, null],
          [null, null, "marron", "marron", null, "marron", null, null],
          [null, null, "vert", "rouge", null, "gris", null, null],
        ]
      },
      // Niveau 14 (index 1)
      {
        name: "Niveau 14",
        moves: 2,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, "gris", "beige", "gris", null, null, null],
          [null, null, "gris", "gris", "vert", null, null, null],
          [null, null, "beige", "vert", "beige", null, null, null],
          [null, null, "gris", "gris", "vert", null, null, null],
        ]
      },
      // Niveau 15 (index 1)
      {
        name: "Niveau 15",
        moves: 3,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, "beige", null, null, null],
          [null, null, null, null, "beige", null, null, null],
          [null, null, "vert", "beige", "vert", "vert", null, null],
          [null, null, "beige", "rouge", "rouge", "beige", null, null],
          [null, null, "rouge", "vert", "beige", "rouge", null, null],
        ]
      },
      // Niveau 16 (index 1)
      {
        name: "Niveau 16",
        moves: 4,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, "vert", "marron", null, null, null],
          [null, null, null, "marron", "vert", null, null, null],
          [null, null, null, "rouge", "beige", null, null, null],
          [null, null, "vert", "beige", "rouge", "marron", null, null],
          [null, null, "vert", "beige", "rouge", "marron", null, null],
        ]
      },
      // Niveau 17 (index 1)
      {
        name: "Niveau 17",
        moves: 3,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, "rouge", null, null, null],
          [null, null, null, null, "vert", null, "beige", null],
          [null, null, "vert", "vert", "rouge", null, "rouge", null],
          [null, null, "gris", "gris", "beige", "gris", "beige", null],
        ]
      },
      // Niveau 18 (index 1)
      {
        name: "Niveau 18",
        moves: 4,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, "marron", null, null],
          [null, null, null, null, "marron", "beige", null, null],
          [null, null, null, null, "rouge", "rouge", null, null],
          [null, null, null, null, "beige", "vert", "marron", null],
          [null, null, "vert", null, "rouge", "vert", "beige", null],
        ]
      },
      // Niveau 19 (index 1)
      {
        name: "Niveau 19",
        moves: 4,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, "beige", "rouge", null, null, null, null],
          [null, null, "rouge", "beige", null, null, null, null],
          [null, null, "beige", "rouge", null, null, null, null],
          [null, null, "rouge", "beige", null, null, null, null],
          [null, null, "beige", "rouge", null, "rouge", null, null],
        ]
      },
      // Niveau 20 (index 1)
      {
        name: "Niveau 20",
        moves: 2,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, "rouge", null, null, null, null, null],
          [null, null, "vert", "vert", null, null, null, null],
          [null, null, "beige", "rouge", null, null, null, null],
          [null, "rouge", "vert", "beige", null, "beige", null, null],
        ]
      },
      // Niveau 21 (index 1)
      {
        name: "Niveau 21",
        moves: 3,
        grid: [
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, null, null, null, null, null],
          [null, null, null, "rouge", null, null, null, null],
          [null, null, null, "rouge", null, null, null, null],
          [null, null, null, "vert", null, null, null, null],
          [null, null, null, "rouge", null, null, null, null],
          [null, null, null, "rouge", null, null, null, null],
          [null, null, null, "vert", null, null, null, null],
          [null, null, "vert", "vert", null, null, null, null],
        ]
      },

    ];

    // ========== CONFIG ==========
    const WIDTH = 8, HEIGHT = 10, ANIM_SPEED = 14;

    // -------- R√©cup√©ration du niveau depuis l‚ÄôURL ---------
    function getParam(name) {
      let m = location.search.match(new RegExp('[?&]' + name + '=(\\d+)'));
      return m ? parseInt(m[1], 10) : null;
    }
    let niveau = getParam('niveau') || 3;
    let currentLevel = niveau - 1; // LEVELS[0]=niveau 3, LEVELS[1]=niveau 4, etc.

    let grid = [], movesLeft = 0, selected = null, anims = [], afterAnimCallback = null;

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const movesElem = document.getElementById('moves');
    const messageElem = document.getElementById('message');
    const resetBtn = document.getElementById('resetBtn');

    // --- INITIALISATION ---
    function initGrid() {
      grid = [];
      let lvl = LEVELS[currentLevel];
      for (let y = 0; y < HEIGHT; y++) {
        grid[y] = [];
        for (let x = 0; x < WIDTH; x++) {
          // On inverse ici : la ligne 0 du niveau devient la ligne la PLUS HAUTE
          let reversedY = HEIGHT - 1 - y;
          let val = (lvl && lvl.grid[reversedY] && lvl.grid[reversedY][x]) || null;
          if (val && COLOR_NAMES[val]) grid[y][x] = { color: COLOR_NAMES[val] };
          else grid[y][x] = null;
        }
      }

      movesLeft = lvl ? lvl.moves : 0;
      movesElem.textContent = movesLeft;
      selected = null;
      messageElem.textContent = '';
    }

    // --- DESSIN ---
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = '#666';
      ctx.fillRect(0, canvas.height - 5, canvas.width, 5);
      for (let y = 0; y < HEIGHT; y++) {
        for (let x = 0; x < WIDTH; x++) {
          const box = grid[y][x];
          if (box) {
            if (anims.find(a => a.gridX === x && a.gridY === y)) continue;
            drawBox(x, y, box.color, selected && selected.x === x && selected.y === y);
          }
        }
      }
      anims.forEach(anim => {
        const { fromX, fromY, toX, toY, color, progress, total, type } = anim;
        let dx = fromX, dy = fromY;
        if (type === "slide") {
          dx = fromX + (toX - fromX) * (progress / total);
          dy = fromY + (toY - fromY) * (progress / total);
        }
        if (type === "fall") {
          dx = toX;
          dy = fromY + (toY - fromY) * (progress / total);
        }
        drawBox(dx, dy, color, false, true);
      });
    }

    // function drawBox(x, y, color, isSelected, isAnim) {
    //   const BOX_SIZE = 50;
    //   const px = x * BOX_SIZE + 5;
    //   const py = canvas.height - (y + 1) * BOX_SIZE + 5;
    //   const grad = ctx.createLinearGradient(px, py, px + BOX_SIZE, py + BOX_SIZE);

    //   // nuance du bois : teinte + fonc√©
    //   grad.addColorStop(0, shadeColor(color, -15));
    //   grad.addColorStop(0.5, color);
    //   grad.addColorStop(1, shadeColor(color, 15));

    //   ctx.save();
    //   ctx.shadowColor = "rgba(0,0,0,0.45)";
    //   ctx.shadowBlur = 8;
    //   ctx.shadowOffsetX = 2;
    //   ctx.shadowOffsetY = 4;

    //   // fond bois avec reflets
    //   roundRect(ctx, px, py, BOX_SIZE - 10, BOX_SIZE - 10, 10, grad);

    //   // ajout de fines "veines" du bois
    //   ctx.strokeStyle = shadeColor(color, -25);
    //   ctx.globalAlpha = 0.15;
    //   for (let i = 0; i < 4; i++) {
    //     const waveY = py + 8 + i * 8;
    //     ctx.beginPath();
    //     ctx.moveTo(px + 4, waveY);
    //     for (let j = 0; j < BOX_SIZE - 20; j += 6) {
    //       ctx.lineTo(px + 4 + j, waveY + Math.sin(j / 3) * 1.2);
    //     }
    //     ctx.stroke();
    //   }

    //   ctx.globalAlpha = 1;
    //   if (isSelected) {
    //     ctx.save();
    //     ctx.strokeStyle = "#fff";
    //     ctx.lineWidth = 4;
    //     ctx.shadowBlur = 12;
    //     ctx.shadowColor = "#fff7";
    //     ctx.strokeRect(px - 2, py - 2, BOX_SIZE - 6, BOX_SIZE - 6);
    //     ctx.restore();
    //   }
    //   ctx.restore();
    // }

    // Cache des motifs bois color√©s (performant)
    const COLORED_WOOD_CACHE = new Map();
    let NEUTRAL_WOOD_TILE = null; // g√©n√®re une fois un bois "√©rable" clair

    function drawBox(x, y, color, isSelected, isAnim) {
      const BOX_SIZE = 50; const px = x * BOX_SIZE + 5;
      const py = canvas.height - (y + 1) * BOX_SIZE + 5;
      ctx.save();
      ctx.shadowColor = "rgba(0,0,0,0.45)";
      ctx.shadowBlur = 8;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 4;
      ctx.globalAlpha = 1;
      roundRect(ctx, px, py, BOX_SIZE - 10, BOX_SIZE - 10, 12, color);
      ctx.globalAlpha = 0.34; roundRect(ctx, px + 7, py + 5, BOX_SIZE - 25, (BOX_SIZE - 20) / 2, 7, "white"); ctx.globalAlpha = 1; if (isSelected) { ctx.save(); ctx.strokeStyle = "#fff"; ctx.lineWidth = 5; ctx.shadowBlur = 20; ctx.shadowColor = "#fff7"; ctx.strokeRect(px - 2, py - 2, BOX_SIZE - 6, BOX_SIZE - 6); ctx.restore(); } ctx.restore();
    }

    // petite fonction utilitaire pour assombrir/√©claircir une couleur
    function shadeColor(color, percent) {
      let f = parseInt(color.slice(1), 16),
        t = percent < 0 ? 0 : 255,
        p = Math.abs(percent) / 100,
        R = f >> 16,
        G = (f >> 8) & 0x00FF,
        B = f & 0x0000FF;
      return (
        "#" +
        (
          0x1000000 +
          (Math.round((t - R) * p) + R) * 0x10000 +
          (Math.round((t - G) * p) + G) * 0x100 +
          (Math.round((t - B) * p) + B)
        )
          .toString(16)
          .slice(1)
      );
    }


    function roundRect(ctx, x, y, w, h, r, color) {
      ctx.beginPath();
      ctx.moveTo(x + r, y);
      ctx.lineTo(x + w - r, y);
      ctx.quadraticCurveTo(x + w, y, x + w, y + r);
      ctx.lineTo(x + w, y + h - r);
      ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
      ctx.lineTo(x + r, y + h);
      ctx.quadraticCurveTo(x, y + h, x, y + h - r);
      ctx.lineTo(x, y + r);
      ctx.quadraticCurveTo(x, y, x + r, y);
      ctx.closePath();
      ctx.fillStyle = color;
      ctx.fill();
    }

    // --- INTERACTIONS ---
    canvas.addEventListener('click', function (e) {
      if (anims.length > 0 || movesLeft <= 0) return;
      const BOX_SIZE = 50;
      const rect = canvas.getBoundingClientRect();
      const mx = e.clientX - rect.left;
      const my = e.clientY - rect.top;
      const x = Math.floor(mx / BOX_SIZE);
      const y = HEIGHT - 1 - Math.floor(my / BOX_SIZE);

      if (x < 0 || x >= WIDTH || y < 0 || y >= HEIGHT) return;

      if (!selected) {
        if (grid[y][x]) {
          selected = { x, y };
          draw();
        }
        return;
      }
      if (selected.x === x && selected.y === y) {
        selected = null;
        draw();
        return;
      }
      if (isAdjacent(selected, { x, y })) {
        moveAndFallAnim(selected, { x, y });
        return;
      }
      if (grid[y][x]) {
        selected = { x, y };
        draw();
        return;
      }
    });

    function isAdjacent(a, b) {
      return (Math.abs(a.x - b.x) + Math.abs(a.y - b.y)) === 1;
    }

    function moveAndFallAnim(a, b) {
      let srcBox = grid[a.y][a.x];
      let destBox = grid[b.y][b.x];
      anims = [];
      anims.push({
        fromX: a.x, fromY: a.y,
        toX: b.x, toY: b.y,
        color: srcBox.color,
        gridX: a.x, gridY: a.y,
        progress: 0,
        total: Math.max(Math.abs(a.x - b.x), Math.abs(a.y - b.y)) * 50 / ANIM_SPEED,
        type: "slide"
      });
      if (destBox) {
        anims.push({
          fromX: b.x, fromY: b.y,
          toX: a.x, toY: a.y,
          color: destBox.color,
          gridX: b.x, gridY: b.y,
          progress: 0,
          total: Math.max(Math.abs(a.x - b.x), Math.abs(a.y - b.y)) * 50 / ANIM_SPEED,
          type: "slide"
        });
      }
      afterAnimCallback = function () {
        [grid[a.y][a.x], grid[b.y][b.x]] = [grid[b.y][b.x], grid[a.y][a.x]];
        let drops = [];
        let dropBoxY = b.y;
        while (dropBoxY > 0 && grid[dropBoxY][b.x] && !grid[dropBoxY - 1][b.x]) {
          drops.push({
            fromY: dropBoxY,
            toY: dropBoxY - 1,
            x: b.x,
            color: grid[dropBoxY][b.x].color
          });
          grid[dropBoxY - 1][b.x] = grid[dropBoxY][b.x];
          grid[dropBoxY][b.x] = null;
          dropBoxY--;
        }
        for (let y = a.y + 1; y < HEIGHT; y++) {
          if (grid[y][a.x]) {
            let curY = y;
            while (curY > 0 && !grid[curY - 1][a.x]) {
              drops.push({
                fromY: curY,
                toY: curY - 1,
                x: a.x,
                color: grid[curY][a.x].color
              });
              grid[curY - 1][a.x] = grid[curY][a.x];
              grid[curY][a.x] = null;
              curY--;
            }
          }
        }
        if (drops.length > 0) {
          anims = drops.map(d => ({
            fromX: d.x, fromY: d.fromY,
            toX: d.x, toY: d.toY,
            color: d.color,
            gridX: d.x, gridY: d.toY,
            progress: 0,
            total: (d.fromY - d.toY) * 50 / ANIM_SPEED,
            type: "fall"
          }));
          afterAnimCallback = finishMove;
          requestAnimationFrame(animLoop);
        } else {
          finishMove();
        }
      };
      requestAnimationFrame(animLoop);
    }

    function finishMove() {
      movesLeft--;
      movesElem.textContent = movesLeft;
      selected = null;
      anims = [];
      afterAnimCallback = null;
      processAfterMove();
    }

    function animLoop() {
      let still = false;
      anims.forEach(anim => {
        anim.progress += 1;
        if (anim.progress < anim.total) still = true;
        else anim.progress = anim.total;
      });
      draw();
      if (still) {
        requestAnimationFrame(animLoop);
      } else if (afterAnimCallback) {
        afterAnimCallback();
      }
    }

    function processAfterMove() {
      draw();
      setTimeout(function () {
        let found = findAndRemoveGroups();
        if (found) {
          setTimeout(applyGravity, 300);
        } else {
          checkEnd();
        }
      }, 200);
    }

    function findAndRemoveGroups() {
      let toRemove = [];
      for (let y = 0; y < HEIGHT; y++) {
        let streak = 1, prevColor = null;
        for (let x = 0; x < WIDTH; x++) {
          let c = grid[y][x]?.color;
          if (c && c === prevColor) streak++;
          else streak = 1;
          if (c && streak >= 3) {
            for (let k = 0; k < streak; k++) toRemove.push({ x: x - k, y });
          }
          prevColor = c;
        }
      }
      for (let x = 0; x < WIDTH; x++) {
        let streak = 1, prevColor = null;
        for (let y = 0; y < HEIGHT; y++) {
          let c = grid[y][x]?.color;
          if (c && c === prevColor) streak++;
          else streak = 1;
          if (c && streak >= 3) {
            for (let k = 0; k < streak; k++) toRemove.push({ x, y: y - k });
          }
          prevColor = c;
        }
      }
      let unique = [];
      let map = {};
      toRemove.forEach(pt => {
        let key = pt.x + ',' + pt.y;
        if (!map[key]) { unique.push(pt); map[key] = true; }
      });
      if (unique.length > 0) {
        for (let pt of unique) {
          if (grid[pt.y][pt.x]) grid[pt.y][pt.x].opacity = 1;
        }
        let step = 0;
        function anim() {
          step++;
          for (let pt of unique) {
            if (grid[pt.y][pt.x]) grid[pt.y][pt.x].opacity = Math.max(0, 1 - step / 10);
          }
          draw();
          if (step < 10) requestAnimationFrame(anim);
          else {
            for (let pt of unique) {
              grid[pt.y][pt.x] = null;
            }
            draw();
          }
        }
        anim();
        return true;
      }
      return false;
    }

    function applyGravity() {
      let changed = false;
      for (let x = 0; x < WIDTH; x++) {
        for (let y = 0; y < HEIGHT - 1; y++) {
          if (!grid[y][x]) {
            for (let y2 = y + 1; y2 < HEIGHT; y2++) {
              if (grid[y2][x]) {
                grid[y][x] = grid[y2][x];
                grid[y2][x] = null;
                changed = true;
                break;
              }
            }
          }
        }
      }
      draw();
      setTimeout(function () {
        let found = findAndRemoveGroups();
        if (found) {
          setTimeout(applyGravity, 300);
        } else {
          checkEnd();
        }
      }, 200);
    }

    function checkEnd() {
      if (isWin()) {
        messageElem.textContent = "Bravo, tu as vid√© toutes les cases ! üéâ";
        sendScoreToServer(1000);
      } else if (movesLeft <= 0) {
        messageElem.textContent = "Plus de mouvements, perdu üòû";
        // Count remaining colored boxes to estimate a score
        let cleared = 0;
        for (let y = 0; y < HEIGHT; y++)
          for (let x = 0; x < WIDTH; x++)
            if (!grid[y][x]) cleared++;
        const total = WIDTH * HEIGHT;
        const clearedRatio = cleared / total;
        const finalScore = Math.round(clearedRatio * 10); // scale 0‚Äì500
        sendScoreToServer(finalScore);
      }
    }

    function sendScoreToServer(finalScore) {
      const userId = localStorage.getItem("user_id");
      if (!userId) {
        console.warn("No user logged in, score not saved.");
        return;
      }

      fetch("php/pages/save_score.php", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          userId: parseInt(userId),
          scoreValue: finalScore,
          gameMode: "casse-tete"
        })
      })
        .then(res => res.json())
        .then(data => {
          if (!data.success) console.warn("Score not saved:", data.error);
          else console.log("Score saved:", finalScore);
        })
        .catch(err => console.error("Error saving score:", err));
    }

    function isWin() {
      for (let y = 0; y < HEIGHT; y++)
        for (let x = 0; x < WIDTH; x++)
          if (grid[y][x]) return false;
      return true;
    }

    resetBtn.addEventListener('click', function () {
      initGrid();
      draw();
    });

    document.getElementById("rulesBtn").addEventListener("click", () => {
      // remove previous splash if it exists
      document.getElementById("splashscreen")?.remove();

      const splash = document.createElement("div");
      splash.id = "splashscreen";
      splash.innerHTML = `
    <div class="splash-content">
      <h3>R√®gles du jeu</h3>
      <ol>
        <li><b>Objectif :</b> R√©soudre le casse-t√™te choisi.</li>
        <li><b>D√©roulement :</b> Chaque casse-t√™te comporte plusieurs carr√©s de diff√©rentes couleurs.<br>
        Le but est de faire dispara√Ætre tous les carr√©s en les regroupant en ligne ou en colonne.<br>
        Cliquez sur un carr√© pour le d√©placer dans une case vide adjacente.<br>
        Quand au moins 3 carr√©s de la m√™me couleur sont align√©s, ils disparaissent et vous marquez des points.</li>
        <li><b>Fin de partie :</b> Quand vous avez fait dispara√Ætre tous les carr√©s ou que vous n'avez plus de coup √† jouer, la partie s'arr√™te.<br>
        Vous pouvez alors recommencer ou changer de casse-t√™te.</li>
      </ol>
      <div class="splash-actions">
        <button id="closeSplash">C'est parti !</button>
      </div>
    </div>
  `;
      document.body.appendChild(splash);

      document.getElementById("closeSplash").addEventListener("click", () => {
        splash.remove(); // gone forever until next click
      });
    });


    // --- INIT ---
    initGrid();
    draw();

  </script>
</body>

</html>